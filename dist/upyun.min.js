/*! Web-Developer-Suite-for-UPYUN 2014-05-01 */
!function(){var a=window.upyun||{};!function(b){"use strict";a.uploader=function(a,c){this.holder=b(a),this.opts={post:{}},this.opts=b.extend(this.opts,c,{}),this.init()},a.uploader.prototype={init:function(){var a=this;this.uploadInput=b('<input type="file"  class="hide mc-upload-holder">'),this.holder.click(function(){a.uploadInput.click()}),a.uploadInput.on("change",function(){function c(b){console.log(b),b.lengthComputable&&a.holder.text(b.loaded+" / "+b.total)}console.log("change");var d=new FormData;void 0!==a.opts.post&&b.each(a.opts.post,function(a,b){console.log(a,b),d.append(a,b)}),d.append("file",this.files[0]),b.ajax({url:a.opts.api,type:"POST",xhr:function(){var a=b.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",c,!1),a},success:function(c){console.log(b.ajaxSettings.xhr().upload),c=b.parseJSON(c),a.opts.onSuccess&&a.opts.onSuccess(c)},data:d,cache:!1,contentType:!1,processData:!1})})}}}(jQuery),function(b){"use strict";a.panel=function(a){this.opts={cover:!0,title:"又拍图片中心",label_cancel:"取消",label_ok:"确定",label_upload:"上传文件",multi:!1,imgWidth:120,imgHeight:74},this._events={},this._folderStack=[],this.opts=b.extend(this.opts,a,{}),this._body=b("body"),this._curPath="/",this.init(),this.setupPanel(),this.eventHandle()},a.panel.prototype={init:function(){},setupPanel:function(){b(".fs-cover").length>0||(this.cover=b('<div style="display:none;" class="fs-cover" />'),this.cover.appendTo(this._body),this.panel=b('<div class="fs-panel" style="height:500px;width:1120px;" />'),this.panel.appendTo(this.cover),this.layoutLeft=b('<div class="fs-panel-left" />'),this.layoutLeft.appendTo(this.panel),this.logo=b('<div id="fs-logo"> <img src="../themes/default/images/logo.png" width="50"> </div>'),this.logo.appendTo(this.layoutLeft),this.toolbar=b('<div class="fs-tool-bar" />'),this.toolbar.appendTo(this.layoutLeft),this.mkdir=b('<a class="fs-mkdir"> <i></i> 创建文件夹 </a>'),this.mkdir.appendTo(this.toolbar),this.upload=b('<a class="fs-upload"> <i></i> 上传文件 </a>'),this.upload.appendTo(this.toolbar),this.layoutRight=b('<div class="fs-panel-right" />'),this.layoutRight.appendTo(this.panel),this.header=b('<div class="fs-header" />'),this.header.appendTo(this.layoutRight),this.headConetnt=b('<div class="fs-header-left" style="width: 950px;"> <h2>又拍图片中心</h2> <p></p> </div>'),this.headConetnt.appendTo(this.header),this.btnClose=b('<a class="fs-close" style="margin-left:960px;">关闭</a>').appendTo(this.header),this.menu=b('<div class="fs-menu" />'),this.menu.appendTo(this.layoutRight),this.breadCrumbs=b('<div class="fs-breadcrumbs" />'),this.breadCrumbs.appendTo(this.menu),this.search=b('<div class="fs-search" />'),this.search.appendTo(this.menu),this.content=b('<div class="fs-content" style="height:340px;" />').appendTo(this.layoutRight),this.mainContent=b('<div class="fs-content-left" />').appendTo(this.content),this.edit=b('<div class="fs-content-right" />').appendTo(this.content),this.footer=b('<div class="fs-footer" />').appendTo(this.layoutRight),this.tip=b("<span>图片总数：125</span>").appendTo(this.footer),this.btnOk=b('<a href="#" class="fs-confirm">确定</a>').appendTo(this.footer),this.btnCancel=b('<a href="#" class="fs-cancel">取消</a>').appendTo(this.footer))},loadData:function(a){var c=this;c.loading||(c.loading=!0,b.post(this.opts.api+"?action=list",{path:c._curPath},function(d){c.loading=!1,d=b.parseJSON(d),a(d.error),0===d.error&&c.mainContent.html("");for(var e=0;e<d.data.length;e++){var f=d.data[e],g=b("<li />").appendTo(c.mainContent);g.append('<a class="fs-del" href="javascript:;" >×</a>'),g.css({width:c.opts.imgWidth}),g.attr("data-name",f.name);var h=b("<img />");"folder"==f.type?(h.attr("src","../themes/default/images/Folder.png"),g.addClass("fs-folder")):h.attr("src",f.url+c.instance.style),h.attr("alt",f.name),h.attr("title",f.name),h.load(function(){var a=this.naturalWidth/this.naturalHeight,d=0,e=0;this.naturalWidth>this.naturalHeight?(d=c.opts.imgWidth,e=d/a,e>c.opts.imgHeight&&(e=c.opts.imgHeight,d=e*a)):(e=c.opts.imgHeight,d=e*a,d>c.opts.imgWidth&&(e=d/a)),b(this).animate({width:d,height:e})}),h.attr("data-name",f.name),g.append(h)}}))},eventHandle:function(){var c=this;this.btnClose.click(function(a){a.preventDefault(),c.close()}),this.btnCancel.click(function(a){a.preventDefault(),c.close(),b("li",c.mainContent).removeClass("fs-selected")}),this.btnOk.click(function(){event.preventDefault();var a=[];b(".fs-selected img",c.mainContent).each(function(){a.push(this.src)}),c.fireEvent("onOK",a),c.close(),b("li",c.mainContent).removeClass("fs-selected")}),this.panel.delegate("li","click",function(){c.instance.multi||b(".fs-selected",c.mainContent).removeClass("fs-selected"),b(this).toggleClass("fs-selected"),b(".fs-selected",c.mainContent).length<1?c.mainContent.css({width:"auto"}):(c.mainContent.css({width:"800px"}),c.fireEvent("onSelected",this))}),new a.uploader(this.upload,{api:this.opts.api+"?action=upload",onSuccess:function(a){if(0!==a.error)return alert(a.msg);b('<li><span style="vertical-align:middle;"><img src="'+a.data.url+'" /></span></li>').prependTo(c.mainContent).click(function(){b(this).toggleClass("fs-selected"),c.fireEvent("onSelected",this)})}}),this.panel.delegate("li,img","mouseenter",function(){b(this).addClass("fs-hover")}),this.panel.delegate("li,img","mouseout",function(){b(this).removeClass("fs-hover")}),this.breadCrumbs.delegate("a","click",function(a){a.preventDefault(),c._openFolder(b(this).attr("href"))}),this.panel.delegate(".fs-del","click",function(a){a.preventDefault();var d=b(this);confirm("确定要删除该文件吗？")&&b.post(c.opts.api+"?action=delete",{path:c._curPath+b(this).next().attr("data-name")},function(a){a=b.parseJSON(a),0===a.error?d.parent().remove():alert(a.msg)})}),this.panel.delegate("li","dblclick",function(){if(b(this).hasClass("fs-folder"))c._openFolder(c._curPath+"/"+b(this).attr("data-name")+"/");else{var a=b(this).find("img").attr("src");c.fireEvent("onOK",[a]),c.close(),b("li",c.mainContent).removeClass("fs-selected")}})},fireEvent:function(a,b){return this.instance&&this.instance.hasOwnProperty(a)?this.instance[a](b):void 0},close:function(){this.cover.hide()},open:function(a){this.instance=a,this._openFolder("/"),this.cover.show(),this.headConetnt.find("p").text(a.title)},resize:function(){},_openFolder:function(a){a=a.replace("//","/");var c=this._folderStack.indexOf(a),d=this;if(0>c){var e=(this._folderStack.indexOf(this._curPath),a.split("/").length-1);this._folderStack.splice(e-1),b("a",this.breadCrumbs).each(function(a,b){a>=e-1&&b.remove()}),d._curPath=a,this.loadData(function(b){0===b&&(d._folderStack.push(a),d.breadCrumbs.append('<a href="'+a+'">'+d._getDirName(a)+"</a>"),d._setBreadSelected(a)),console.log("stack",d._folderStack)})}else d._curPath=a,this.loadData(function(b){0===b&&d._setBreadSelected(a)})},_getDirName:function(a){var b=a.match(/([^/])*\/$/)[0];return b.length<1?"/":b},_setBreadSelected:function(a){b("a",this.breadCrumbs).each(function(){b(this).attr("href")==a?b(this).addClass("cur-bread"):b(this).removeClass("cur-bread")})}}}(jQuery),function(b){b.fn.upyun=function(c){return this.each(function(){var d={style:"!small",multi:!1},e=b(this);d=b.extend(d,c,{}),void 0===window._upanel&&(window._upanel=new a.panel({api:d.api})),d.title=d.title||e.attr("data-title")||"请选择图片",d.onOK=d.onOK||function(a){e.val(a[0])},e.click(function(){window._upanel.open(d)})})}}(jQuery)}(jQuery);