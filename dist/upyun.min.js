/*! Web-Developer-Suite-for-UPYUN 2014-04-27 */
function mcUploader(a,b){this.holder=$(a),this.opts={post:{}},this.opts=$.extend(this.opts,b,{}),this.init()}function mc(a){this.opts={cover:!0,title:"又拍图片中心",label_cancel:"取消",label_ok:"确定",label_upload:"上传文件",multi:!1,imgWidth:120,imgHeight:74},this._events={},this.opts=$.extend(this.opts,a,{}),this._body=$("body"),this.path="/",this.init(),this.setupPanel(),this.loadData(),this.eventHandle()}mcUploader.prototype={init:function(){var a=this;this.uploadInput=$('<input type="file"  class="hide mc-upload-holder">'),this.holder.click(function(){a.uploadInput.click()}),a.uploadInput.on("change",function(){function b(b){console.log(b),b.lengthComputable&&a.holder.text(b.loaded+" / "+b.total)}console.log("change");var c=new FormData;void 0!==a.opts.post&&$.each(a.opts.post,function(a,b){console.log(a,b),c.append(a,b)}),c.append("file",this.files[0]),$.ajax({url:a.opts.api,type:"POST",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",b,!1),a},success:function(b){console.log($.ajaxSettings.xhr().upload),b=$.parseJSON(b),a.opts.onSuccess&&a.opts.onSuccess(b)},data:c,cache:!1,contentType:!1,processData:!1})})}},mc.prototype={init:function(){console.log("init"),this.opts.cover&&this.setupCover()},setupCover:function(){$(".mc-cover").length>0?this.cover=$(".mc-cover"):(this.cover=$('<div class="hide mc-cover"> </div>'),this.cover.appendTo(this._body))},setupPanel:function(){var a=this;$(".mc-panel").length>0||(this.panel=$('<div class="mc-panel"></div>'),this.panel.appendTo(this.cover),this.mcheader=$('<div class="mc-header"/>'),this.mcheader.appendTo(this.panel),this.mcheader.text(this.opts.title),this.btnClose=$('<span class="mc-close" >×</span>'),this.mcbody=$('<div class="mc-body" />'),this.mcbody.appendTo(this.panel),console.log(this.panel.height()),this.uploadPanel=$('<div class="mc-upload-panel" />'),this.uploadPanel.appendTo(this.mcbody).text("上传"),this.picsList=$('<ul class="mc-list" />'),this.picsList.appendTo(this.mcbody),new mcUploader(this.uploadPanel[0],{api:this.opts.api+"?action=upload",onSuccess:function(b){$('<li><span style="vertical-align:middle;"><img src="'+b.data.url+'" /></span></li>').prependTo(a.picsList).click(function(){$(this).toggleClass("mc-selected"),a.fireEvent("onSelected",this)})}}),this.mcfooter=$('<div class="mc-footer" />'),this.mcfooter.appendTo(this.panel),this.btnOk=$('<button class="mc-btn-ok" />').text(this.opts.label_ok),this.btnOk.appendTo(this.mcfooter),this.btnCancel=$('<button class="mc-btn-cancel" />').text(this.opts.label_cancel),this.btnCancel.appendTo(this.mcfooter),this.btnClose.appendTo(this.mcheader),this.btnClose.click(function(){a.close(),$("li",a.picsList).removeClass("mc-selected")}),this.btnCancel.click(function(){a.close(),$("li",a.picsList).removeClass("mc-selected")}),this.btnOk.click(function(){var b=[];$(".mc-selected img",a.picsList).each(function(){b.push(this.src)}),a.fireEvent("onOK",b),a.close(),$("li",a.picsList).removeClass("mc-selected")}),this.mcbody.height(this.panel.height()-60))},loadData:function(){var a=this;$.post(this.opts.api+"?action=list",{},function(b){b=$.parseJSON(b);for(var c=0;c<b.length;c++)if("file"==b[c].type){var d=$("<li />").appendTo(a.picsList);d.append('<a class="mc-del" href="javascript:;" >×</a>');var e=$("<img />");e.attr("src",b[c].url),e.attr("alt",b[c].name),e.attr("title",b[c].name),e.load(function(){var b=this.naturalWidth/this.naturalHeight,c=0,d=0;this.naturalWidth>this.naturalHeight?(c=a.opts.imgWidth,d=c/b,d>a.opts.imgHeight&&(d=a.opts.imgHeight,c=d*b)):(d=a.opts.imgHeight,c=d*b,c>a.opts.imgWidth&&(d=c/b)),this.width=c,this.height=d}),e.attr("data-name",b[c].name),d.append(e)}})},selectHandle:function(){},eventHandle:function(){var a=this;this.opts.cover&&this.cover.delegate(".mc-cover","click",function(){a.close()}),this.mcbody.delegate("li","click",function(){$(this).toggleClass("mc-selected"),a.fireEvent("onSelected",this)}),this.mcbody.delegate("li,img","mouseenter",function(){$(this).addClass("mc-hover")}),this.mcbody.delegate("li,img","mouseout",function(){$(this).removeClass("mc-hover")}),this.mcbody.delegate(".mc-del","click",function(b){b.preventDefault();var c=$(this);confirm("确定要删除该文件吗？")&&$.post(a.opts.api+"?action=delete",{path:a.path+$(this).next().attr("data-name")},function(a){a=$.parseJSON(a),console.log(a),0===a.error?c.parent().remove():alert(a.msg)})}),this.mcbody.delegate("li","dblclick",function(){var b=$(this).find("img").attr("src");a.fireEvent("onOK",[b]),a.close(),$("li",a.picsList).removeClass("mc-selected")}),$(window).resize(function(){console.log(a.panel.height()),a.mcbody.height(a.panel.height()-60)})},fireEvent:function(a,b){return this.instance.hasOwnProperty(a)?(console.log(a,"fired"),this.instance[a](b)):void 0},close:function(){this.opts.cover&&this.cover.hide(),this.panel.hide()},open:function(a){this.instance=a,this.opts.cover&&this.cover.show(),this.setupPanel(),$(window).resize(),this.panel.show()},resize:function(){}},function(a){function b(b,c){var d=this;void 0===window._upanel&&(window._upanel=new mc({api:c.api})),this.element=a(b),c.panel?this.element.click(function(){window._upanel.open({onOK:function(b){d.element.val(b[0]),a("#holder").attr("src",b[0])}})}):new mcUploader({api:c.api+"?action=upload"})}a.fn.upyun=function(c){return this.each(function(){a.data(this,"upyun")||a.data(this,"upyun",new b(this,c))})}}(jQuery);