/*! Web-Developer-Suite-for-UPYUN 2014-05-06 */
!function(){var a=window.upyun||{};a.util={getDirName:function(a){var b=a.match(/([^/])*\/$/)[0];return b.length<1?"/":b},getScale:function(a,b,c,d){var e=a/b;return a>b?(nw=c,nh=nw/e,nh>d&&(nh=d,nw=nh*e)):(nh=d,nw=nh*e,nw>c&&(nh=nw/e)),{width:nw,height:nh}},formatDate:function(a){var b=new Date(1e3*a),c=b.getMonth()+1,d=b.getFullYear(),e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c=10>c?"0"+c.toString():c,f=10>f?"0"+f.toString():f,g=10>g?"0"+g.toString():g,h=10>h?"0"+h.toString():h,d+"-"+c+"-"+e+" "+f+":"+g+":"+h}},function(b){"use strict";a.uploader=function(a,c){this.trigger=b(a),this.opts={post:{},multi:!1},this.opts=b.extend(this.opts,c,{}),this.init()},a.uploader.prototype={init:function(){var a=this;this.uploadInput=b('<input type="file"  class="hide mc-upload-holder">'),this.trigger.click(function(){a.uploadInput.click()}),a.uploadInput.on("change",function(){function c(b){console.log(b),b.lengthComputable&&a.trigger.text(b.loaded+" / "+b.total)}var d=new FormData;void 0!==a.opts.post&&b.each(a.opts.post,function(a,b){d.append(a,b)}),d.append("file",this.files[0]),b.ajax({url:a.opts.api,type:"POST",xhr:function(){var a=b.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",c,!1),a},success:function(c){console.log(b.ajaxSettings.xhr().upload),c=b.parseJSON(c),a.opts.onSuccess&&a.opts.onSuccess(c)},data:d,cache:!1,contentType:!1,processData:!1})})},setOpts:function(a){this.opts=b.extend(this.opts,a,{}),this.opts.multi&&this.uploadInput.attr("multiple","multiple")}}}(jQuery),function(b){"use strict";a.panel=function(a){this.opts={cover:!0,title:"又拍图片中心",label_cancel:"取消",label_ok:"确定",label_upload:"上传文件",multi:!1,imgWidth:120,imgHeight:74},this._events={},this._folderStack=[],this.opts=b.extend(this.opts,a,{}),this._curPath="/",this._folderICO="../themes/default/images/Folder.png",this.init(),this.setupPanel(),this.eventHandle()},a.panel.prototype={init:function(){},setupPanel:function(){if(!(b(".fs-cover").length>0)){var a='<div style="display:none;" class="fs-cover"><div class="fs-panel" style="height:500px;width:1120px;"><div class="fs-panel-left"><div id="fs-logo"><img src="../themes/default/images/logo.png" width="50"></div><div class="fs-tool-bar"><a class="fs-mkdir"><i></i>创建文件夹</a><a class="fs-upload"><i></i>上传图片</a></div></div><div class="fs-panel-right"><div class="fs-header"><div class="fs-header-left" style="width: 950px;"><h2>又拍图片中心</h2><p>请选择一张图片作为你的logo</p></div><a class="fs-close" style="margin-left:960px;">关闭</a></div><div class="fs-cfm"><div class="fs-cfm-wrapper"><div class="fs-msg"><i></i><span>确定要删除吗？</span></div><div class="fs-cfm-footer"><a href="#" class="fs-cancel">取消</a><a href="#" class="btn fs-confirm">确定</a></div></div></div><div class="fs-alert"><div class="fs-alert-wrapper"><div class="fs-msg"><i></i><span>出了一点问题</span></div><div class="fs-alert-footer"><a href="#" class="btn fs-confirm">确定</a></div></div></div><div class="fs-menu"><div class="fs-breadcrumbs"></div><div class="fs-search"></div></div><div class="fs-content" style="height:340px;"><div class="fs-content-left" style="width:800px"></div><div class="fs-content-right" style="margin-left:800px"></div></div><div class="fs-footer"><span>图片总数：125</span><a class="fs-confirm">确定</a><a class="fs-cancel">取消</a></div></div></div></div>';this._body=b("body"),this.cover=b(a).appendTo(this._body),console.log(this.cover),this.panel=b(".fs-panel",this.cover),this.layoutLeft=b(".fs-panel-left",this.cover),this.toolbar=b(".fs-tool-bar",this.layoutLeft),this.upload=b(".fs-upload",this.toolbar),this.layoutRight=b(".fs-panel-right",this.cover),this.header=b(".fs-header",this.layoutRight),this.headConetnt=b(".fs-header-left",this.layoutRight),this.btnClose=b(".fs-close",this.header),this.menu=b(".fs-menu",this.layoutRight),this.breadCrumbs=b(".fs-breadcrumbs",this.menu),this.search=b(".fs-search",this.menu),this.content=b(".fs-content",this.layoutRight),this.mainContent=b(".fs-content-left",this.content),this.edit=b(".fs-content-right",this.content),console.log(this.edit),this.footer=b(".fs-footer",this.layoutRight),this.tip=b("span",this.footer),this.btnOk=b(".fs-confirm",this.footer),this.btnCancel=b(".fs-cancel",this.footer),this.confirm=b(".fs-cfm",this.layoutRight),this.alert=b(".fs-alert",this.layoutRight)}},loadData:function(a){var c=this;c.loading||(c.loading=!0,b.post(this.opts.api+"?action=list",{path:c._curPath},function(d){c.loading=!1,d=b.parseJSON(d),a(d.error),0===d.error&&c.mainContent.html("");for(var e=0;e<d.data.length;e++){var f=d.data[e];c._appendFile(f)}}))},eventHandle:function(){var c=this;this.btnClose.click(function(a){a.preventDefault(),c.close()}),this.btnCancel.click(function(a){a.preventDefault(),c.close(),b("li",c.mainContent).removeClass("fs-selected")}),this.btnOk.click(function(){event.preventDefault();var a=[];b(".fs-selected img",c.mainContent).each(function(){a.push(this.src)}),c.fireEvent("onOK",a),c.close(),b("li",c.mainContent).removeClass("fs-selected")}),this.mainContent.delegate("li","click",function(){c.instance.multi||b(".fs-selected",c.mainContent).removeClass("fs-selected"),b(this).toggleClass("fs-selected"),b(".fs-selected",c.mainContent).length<1?c.mainContent.css({width:"auto"}):(c.mainContent.css({width:"800px"}),c.fireEvent("onSelected",this));var d=b(this).attr("data-type"),e={type:b(this).attr("data-type"),name:b(this).attr("data-name"),url:c._folderICO,time:a.util.formatDate(parseInt(b(this).attr("data-time"),10))};"file"==d&&(e.url=b(this).attr("data-url")+c.instance.style,e.size=(parseInt(b(this).attr("data-size"),10)/1024).toFixed(2)),c._editFile(e)}),this.uploader=new a.uploader(this.upload,{api:this.opts.api+"?action=upload",onSuccess:function(a){return 0!==a.error?alert(a.msg):c._appendFile(a.data,!0)}}),this.panel.delegate("li,img","mouseenter",function(){b(this).addClass("fs-hover")}),this.panel.delegate("li,img","mouseout",function(){b(this).removeClass("fs-hover")}),this.breadCrumbs.delegate("a","click",function(a){a.preventDefault(),c._openFolder(b(this).attr("href"))}),this.panel.delegate(".fs-del","click",function(a){a.preventDefault();b(this);return c._confirm("danger","确定要删除该文件吗？",function(a){console.log(a)})}),this.panel.delegate("li","dblclick",function(){if(b(this).hasClass("fs-folder"))c._openFolder(c._curPath+"/"+b(this).attr("data-name")+"/");else{var a=b(this).find("img").attr("src");c.fireEvent("onOK",[a]),c.close(),b("li",c.mainContent).removeClass("fs-selected")}})},fireEvent:function(a,b){return this.instance&&this.instance.hasOwnProperty(a)?this.instance[a](b):void 0},close:function(){this.cover.hide()},open:function(a){this.instance=a,this._openFolder("/"),this.cover.show(),console.log(this.cover),this.headConetnt.find("p").text(a.title)},resize:function(){},_openFolder:function(c){c=c.replace("//","/");var d=this._folderStack.indexOf(c),e=this;if(0>d){var f=(this._folderStack.indexOf(this._curPath),c.split("/").length-1);this._folderStack.splice(f-1),b("a",this.breadCrumbs).each(function(a,b){a>=f-1&&b.remove()}),e._curPath=c,this.loadData(function(b){if(0===b){var d=a.util.getDirName(c);e._folderStack.push(c),e.breadCrumbs.append('<a href="'+c+'">'+d+"</a>"),e._setBreadSelected(c),e._editFile({name:"/"==d?"根目录":d,url:e._folderICO})}console.log("stack",e._folderStack)})}else e._curPath=c,this.loadData(function(a){0===a&&e._setBreadSelected(c)});this.uploader.setOpts({multi:!0,post:{path:this._curPath}})},_setBreadSelected:function(a){b("a",this.breadCrumbs).each(function(){b(this).attr("href")==a?b(this).addClass("cur-bread"):b(this).removeClass("cur-bread")})},_confirm:function(a,c,d){var e=this;this.confirm.animate({height:"150"}),this.confirm.undelegate("a","click"),this.confirm.delegate("a","click",function(a){a.preventDefault(),d(b(this).hasClass("fs-confirm")),e.confirm.animate({height:0})})},_alert:function(){var a=this;this.alert.animate({height:"150"}),this.alert.undelegate("a","click"),this.alert.delegate("a","click",function(b){b.preventDefault(),a.alert.animate({height:0})})},_prompt:function(){var a=this;this.prompt.animate({height:"150"}),this.prompt.undelegate("a","click"),this.prompt.delegate("a","click",function(b){b.preventDefault(),a.prompt.animate({height:0})})},_editFile:function(a){var c=b("<img />").attr("src",a.url),d=b('<ul class="fs-info" />');d.append("<li>名称："+a.name+"</li>"),a.size>0&&d.append("<li>大小："+a.size+"K</li>"),a.time&&d.append("<li>创建时间："+a.time+"</li>"),this.edit.html(""),this.edit.append(c).append(d)},_appendFile:function(c,d){var e=this,f=b("<img />"),g=b("<li />");if(g.append('<a class="fs-del" href="#" >×</a>'),g.css({width:e.opts.imgWidth}),g.attr("data-name",c.name),g.attr("data-size",c.size),g.attr("data-type",c.type),g.attr("data-time",c.time),g.attr("data-url",c.url),"folder"==c.type?(f.attr("src",e._folderICO),g.addClass("fs-folder")):f.attr("src",c.url+e.instance.style),f.attr("alt",c.name),f.attr("title",c.name),c.width&&c.height){var h=a.util.getScale(c.width,c.height,e.opts.imgWidth,e.opts.imgHeight);f.css(h)}else f.load(function(){var c=a.util.getScale(this.naturalWidth,this.naturalHeight,e.opts.imgWidth,e.opts.imgHeight);b(this).animate(c)});f.attr("data-name",c.name),g.append(f),d?"file"==c.type?b(".fs-folder:last",e.mainContent).after(g):g.prependTo(e.mainContent):g.appendTo(e.mainContent)}}}(jQuery),function(b){b.fn.upyun=function(c){return this.each(function(){var d={style:"!small",multi:!1},e=b(this);d=b.extend(d,c,{}),void 0===window._upanel&&(window._upanel=new a.panel({api:d.api})),d.title=d.title||e.attr("data-title")||"请选择图片",d.onOK=d.onOK||function(a){e.val(a[0])},e.click(function(){window._upanel.open(d)})})}}(jQuery)}(jQuery);