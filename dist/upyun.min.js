/*! Web-Developer-Suite-for-UPYUN 2014-05-28 */
window.upyun=window.upyun||{},upyun.util={getDirName:function(a){var b=a.match(/([^/])*\/$/)[0];return b.length<1?"/":b},getScale:function(a,b,c,d){var e=a/b;return a>b?(nw=c,nh=nw/e,nh>d&&(nh=d,nw=nh*e)):(nh=d,nw=nh*e,nw>c&&(nh=nw/e)),{width:nw,height:nh}},formatDate:function(a){var b=new Date(1e3*a),c=b.getMonth()+1,d=b.getFullYear(),e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c=10>c?"0"+c.toString():c,f=10>f?"0"+f.toString():f,g=10>g?"0"+g.toString():g,h=10>h?"0"+h.toString():h,[d,c,e].join("-")+" "+[f,g,h].join(":")},checkOpts:function(a){var b={title:"请选择图片",panelLogo:"../themes/default/images/logo.png",editorIcon:"../themes/default/images/cloud.png",folderIcon:"../themes/default/images/Folder.png",loadingIcon:"../themes/default/images/loading.gif",tWidth:120,tHeight:74,multiSelect:!1,multiUpload:!1,style:"!small",theme:"default"};return $.extend(b,a,{})},urlConcat:function(a,b){return a=a.split("#")[0],[a,b].join(-1===a.indexOf("?")?"?":"&")},renderImg:function(a){var b='<a target="#target#" href="#href#"><img #width# #height# alt="#alt#" src="#src#"></a>';return a.href=a.href||"",a.alt=a.alt||"",a.width=a.width?'width="'+a.width+'"':"",a.height=a.height?'height="'+a.height+'"':"",a.blank=a.blank||"",b.replace("#href#",a.href).replace("#src#",a.url).replace("#alt#",a.alt).replace("#target#",a.blank).replace("#width#",a.width).replace("#height#",a.height)}},function(a){"use strict";upyun.uploader=function(b,c){this.trigger=a(b),this.opts={post:{},multiUpload:!1},this.opts=a.extend(this.opts,c,{}),this.init()},upyun.uploader.prototype={init:function(){var b=this;this.uploadInput=a('<input type="file" class="hide mc-upload-holder">'),this.trigger.click(function(){b.uploadInput.click()}),b.uploadInput.on("change",function(){function c(){}for(var d=0,e=this.files.length;e>d;d++){var f=new FormData;void 0!==b.opts.post&&a.each(b.opts.post,function(a,b){f.append(a,b)}),f.append("file",this.files[d]),a.ajax({url:b.opts.api,type:"POST",xhr:function(){var b=a.ajaxSettings.xhr();return b.upload&&b.upload.addEventListener("progress",c,!1),b},success:function(c){console.log(a.ajaxSettings.xhr().upload),c=a.parseJSON(c),b.opts.onSuccess&&b.opts.onSuccess(c)},data:f,cache:!1,contentType:!1,processData:!1})}})},setOpts:function(b){this.opts=a.extend(this.opts,b,{});var c="";this.opts.multiUpload&&(c="multiple"),this.uploadInput.attr("multiple","multiple")}}}(jQuery),function(a){"use strict";upyun.panel=function(a){this._stack=[],this._theme="default",a&&(this._theme=a),this._curPath="/",this.idoc=null,this._setup(),this.eventHandle()},upyun.panel.prototype={loadData:function(b,c){if(!this.loading){var d=this;d.loading=!0,a.post(this._getUrl("list"),{path:b},function(b){d.loading=!1,b=a.parseJSON(b),c(b.error),0===b.error&&d.objsHolder.html("");for(var e=0;e<b.data.length;e++){var f=b.data[e];d._appendFile(f)}d._cnt.text(b.data.length)})}},eventHandle:function(){var b=this;this.btnClose.click(function(a){a.preventDefault(),b.close()}),this.btnCancel.click(function(a){a.preventDefault(),b.close()}),this.btnOk.click(function(){var a=b;event.preventDefault();var c={url:a._g("image").attr("src"),width:a._g("width").val(),height:a._g("height").val(),alt:a._g("alt").val(),href:a._g("href").val(),blank:a._g("blank").val()};a.fireEvent("onOK",[c]),a.close()}),this.objsHolder.delegate("li","click",function(){b.now.multiSelect||a(".selected",b.objsHolder).removeClass("selected"),a(this).toggleClass("selected"),a(".selected",b.objsHolder).length<1?b.objsHolder.css({width:"auto"}):(b.objsHolder.css({width:"800px"}),b.fireEvent("onSelected",this));var c=a(this)._d("type"),d={type:c,name:a(this)._d("name"),url:b.now.folderIcon,time:upyun.util.formatDate(parseInt(a(this)._d("time"),10))};"file"==c&&(d.url=a(this)._d("url"),d.size=(parseInt(a(this)._d("size"),10)/1024).toFixed(2)),b._editFile(d)}),this.uploader=new upyun.uploader(this.upload,{onSuccess:function(a){return 0!==a.error?alert(a.msg):b._appendFile(a.data,!0)}}),this.objsHolder.delegate("li","mouseenter",function(){a(this).addClass("hover")}),this.objsHolder.delegate("li","mouseleave",function(){a(this).removeClass("hover")}),this.breadCrumbs.delegate("a","click",function(c){c.preventDefault(),b._openFolder(a(this).attr("href"))}),this.mkdir.click(function(c){c.preventDefault(),b._dialog("prompt","请输入文件夹名称",function(c,d){a.post(b._getUrl("mkdir"),{path:b._curPath,name:d},function(c){c=a.parseJSON(c),0===c.error?(b._dialog("success",c.msg),b._appendFile(c.data,!0)):b._dialog("error",c.msg)})})}),this.objsHolder.delegate(".delete","click",function(c){c.preventDefault();var d=a(this);return b._dialog("confirm","确定要删除该文件吗？",function(a){a&&b._deleteFile(d.parent()._d("name"),function(a){a&&(d.parent().remove(),b._cnt.text(parseInt(b._cnt.text(),10)-1))})})}),this.objsHolder.delegate("li","dblclick",function(){if(a(this).hasClass("folder"))b._openFolder(b._curPath+"/"+a(this)._d("name")+"/");else{var c=a(this)._d("url");b.fireEvent("onOK",[{url:c}]),b.close()}})},fireEvent:function(a,b){return this.now&&this.now.hasOwnProperty(a)?this.now[a](b):void 0},close:function(){a("li",this.objsHolder).removeClass("selected"),this.cover.hide()},open:function(a){var b=upyun.util.checkOpts(a);this._applyOpts(b),this.now=b,this._openFolder("/"),this.cover.show()},_openFolder:function(a){var b=this;a=a.replace("//","/"),this.loadData(a,function(c){0===c&&b._setPath(a)})},_setPath:function(b){var c=this._stack.indexOf(b),d=a("a",this.breadCrumbs);if(0>c){var e=(this._stack.indexOf(this._curPath),b.split("/").length-1);this._stack.splice(e-1),d.each(function(a,b){a>=e-1&&b.remove()}),this._curPathName=upyun.util.getDirName(b),this._stack.push(b),this.breadCrumbs.append('<a href="'+b+'">'+this._curPathName+"</a>")}this._curPath=b,d.removeClass("cur-bread"),a("a",this.breadCrumbs).each(function(){a(this).attr("href")==b&&a(this).addClass("cur-bread")}),this.uploader.setOpts({api:this._getUrl("upload"),post:{path:b}})},_dialog:function(b,c,d){var e=this,f=a(".msg",this.dialog),g=a("a",this.dialog);f.attr("class","msg"),f.addClass(""+b),f.html("<i></i>"),g.show(),"prompt"==b?f.html("<span>"+c+'</span><input class="v" type="text" />'):("confirm"!=b&&a(".cancel",this.dialog).hide(),f.html("<span>"+c+"</span>")),this.dialog.animate({height:"150"}),this.dialog.undelegate("a","click"),this.dialog.delegate("a","click",function(b){b.preventDefault();var c=a(".v",f),g=!1;c.length>0&&(g=c.val()),d&&d(a(this).hasClass("confirm"),g),e.dialog.animate({height:0})})},_editFile:function(b){var c=a('<img class="image" />').attr("src",b.url),d=a('<ul class="info" />');if(d.append("<li>名称："+b.name+"</li>"),b.size>0&&d.append("<li>大小："+b.size+"K</li>"),b.time&&d.append("<li>创建时间："+b.time+"</li>"),this.edit.html(""),this.edit.append(d),this.now.richEditor&&"file"==b.type){var e=a('<ul class="meta" />');e.append('<li><label>宽度：<input class="width" type="text" /></label></li>'),e.append('<li><label>高度：<input class="height" type="text" /></label></li>'),e.append('<li><label>链接：<input class="href" value="'+b.url+'" type="text" /></label></li>'),e.append('<li><label>代替文本：<input class="alt" value="'+b.name+'" type="text" /></label></li>'),e.append('<li><label>新标签中打开：<input class="blank" value="" type="checkbox" /></label></li>'),this.edit.append(e),c.load(function(){a(".width").val(this.width),a(".height").val(this.height)})}this.edit.prepend(c)},_appendThumb:function(b,c){if("file"==b.type)return this._appendThumb(b,c);var d=this,e=a("<img />"),f=a('<img class="thumb-loading" />'),g=a('<li class="item" />'),h=["name","size","type","time","url","width","height"];g.append('<a class="delete" href="#" >×</a>'),g.css({width:d.now.tWidth,height:d.now.tHeight}),f.attr("src",d.now.loadingIcon),g.append(f);for(var i=0;i<h.length;i++){var j=h[i];void 0!==b[j]&&g.attr("data-"+j,b[j])}e.attr("src",b.url+d.now.style),e.attr("alt",b.name),e.attr("title",b.name),e._d("name",b.name),e.load(function(){var b=upyun.util.getScale(this.naturalWidth,this.naturalHeight,d.now.tWidth,d.now.tHeight);b={width:.9*b.width,height:.9*b.height},a(this).css(b),a(this).show(),f.remove()}),e.hide(),g.append(e),c?(a(".folder:last",d.objsHolder).after(g),d._cnt.text(parseInt(d._cnt.text(),10)+1)):g.appendTo(d.objsHolder)},_appendFile:function(b,c){var d=this,e=a("<img />"),f=a('<img class="thumb-loading" />'),g=a('<li class="item" />'),h=["name","size","type","time","url","width","height"];g.append('<a class="delete" href="#" >×</a>'),g.css({width:d.now.tWidth,height:d.now.tHeight}),f.attr("src",d.now.loadingIcon),g.append(f);for(var i=0;i<h.length;i++){var j=h[i];void 0!==b[j]&&g.attr("data-"+j,b[j])}if("folder"==b.type?(e.attr("src",d.now.folderIcon),g.addClass("folder")):e.attr("src",b.url+d.now.style),e.attr("alt",b.name),e.attr("title",b.name),e._d("name",b.name),b.width&&b.height){var k=upyun.util.getScale(b.width,b.height,d.now.tWidth,d.now.tHeight);k={width:.9*k.width,height:.9*k.height},e.css(k)}else e.load(function(){var b=upyun.util.getScale(this.naturalWidth,this.naturalHeight,d.now.tWidth,d.now.tHeight);b={width:.9*b.width,height:.9*b.height},a(this).css(b),a(this).show(),f.remove()});e.hide(),g.append(e),"folder"==b.type&&g.append("<p>"+b.name+"</p>"),c?("file"==b.type?a(".folder:last",d.objsHolder).after(g):g.prependTo(d.objsHolder),d._cnt.text(parseInt(d._cnt.text(),10)+1)):g.appendTo(d.objsHolder)},_deleteFile:function(b,c){var d=this;a.post(this._getUrl("delete"),{path:this._curPath,name:b},function(b){b=a.parseJSON(b),0===b.error?(c(!0),d._dialog("success","删除成功")):(c(!1),d._dialog("error",b.msg))})},_applyOpts:function(b){a("img",this.logo).attr("src",b.panelLogo),this.headConetnt.find("p").text(b.title),this.uploader.setOpts({multiSelect:b.multiSelect})},_getUrl:function(a){return upyun.util.urlConcat(this.now.api,"action="+a)},_g:function(b){return a("."+b,this.idoc)},_setup:function(){var b=this;if(!(b._g("cover").length>0)){var c=document.createElement("iframe");document.domain=c.domain=location.host,c.id="panel",c.name="panel",c.width="100%",c.height="100%",c.frameBorder="0",c.src="javascript:void(0)",this.cover=a('<div style="display:none;" class="cover"></div>'),this.cover.css({background:"url(../themes/default/images/cover.png) no-repeat","background-size":"cover",position:"fixed","padding-top":"2%",top:"0",left:"0",width:"100%",height:"100%","z-index":1e5}),this.cover.appendTo(a("body")),this.cover.append(c);var d='<div class="panel" style="height:500px;width:1120px;"><div class="panel-left"><div id="logo"><img src="../themes/default/images/logo.png" width="50"></div><div class="tool-bar"><a class="mkdir"><i></i>创建文件夹</a><a class="upload"><i></i>上传图片</a></div></div><div class="panel-right"><div class="header"><div class="header-left" style="width: 950px;"><h2>又拍图片中心</h2><p>请选择一张图片作为你的logo</p></div><a class="close" style="margin-left:960px;">关闭</a></div><div class="dialog"><div class="dialog-wrapper"><div class="msg"><i></i><span>确定要删除吗？</span></div><div class="dialog-footer"><a href="#" class="cancel">取消</a><a href="#" class="confirm">确定</a></div></div></div><div class="menu"><div class="breadcrumbs"></div><div class="search"></div></div><div class="content" style="height:340px;"><div class="content-left" style="width:800px"></div><div class="content-right" style="margin-left:800px"></div></div><div class="footer"><span>对象总数：<span class="cnt" >125</span></span><a href="#" class="confirm">确定</a><a href="#" class="cancel">取消</a></div></div></div>';this.idoc=a("#panel").contents(),this.idoc.find("head").append('<link rel="stylesheet" href="../themes/'+this._theme+'/style.css" type="text/css" media="screen">'),this.idoc.find("body").html(d),b.panel=b._g("panel"),b.layoutLeft=b._g("panel-right"),b.toolbar=b._g("tool-bar"),b.upload=b._g("upload"),b.layoutRight=b._g("panel-right"),b.header=b._g("header"),b.headConetnt=b._g("header-left"),b.btnClose=b._g("close"),b.menu=b._g("menu"),b.breadCrumbs=b._g("breadcrumbs"),b.search=b._g("search"),b.content=b._g("content"),b.objsHolder=b._g("content-left"),b.edit=b._g("content-right"),b.footer=b._g("footer"),b.tip=a("span",this.footer),b.btnOk=a(".confirm",this.footer),b.btnCancel=a(".cancel",this.footer),b.dialog=b._g("dialog"),b._cnt=b._g("cnt"),b.mkdir=b._g("mkdir"),b.logo=b._g("logo"),a.fn.extend({_d:function(b){return a(this).attr("data-"+b)}})}}}}(jQuery),function(a){a.fn.upyun=function(b){return void 0===window._upanel&&(window._upanel=new upyun.panel(b.theme)),this.each(function(){{var c=a(this);b.holder||c.attr("data-holder")}b.title=b.title||c.attr("data-title"),b.api=b.api||c.attr("data-api"),b.onOK=b.onOK||function(a){for(var b=0,d=a.length;d>b;b++){var e=a[b];c.val(e.url)}},c.click(function(){window._upanel.open(b)})})}}(jQuery),function(a){"use strict";void 0===upyun.setUpUEditor&&(upyun.setUpUEditor=function(b,c){var d='<div  class="edui-box edui-button edui-for-upyun edui-default"><div class="edui-default"><div class="edui-button-wrap edui-default"><div unselectable="on" title="又拍" class="edui-button-body edui-default"><div class="edui-box edui-icon edui-default"></div><div class="edui-box edui-label edui-default"></div></div></div></div></div>',e=a(".edui-toolbar"),f=a(d);return c=upyun.util.checkOpts(c),e.length<1?(console.log("集成 UEDITOR 失败"),!1):(f.appendTo(e),a(".edui-icon",f).css({"background-image":"url("+c.editorIcon+")","background-size":"cover"}),c.onOK=function(a){for(var c=0,d=a.length;d>c;c++){var e=upyun.util.renderImg(a[c]);b.execCommand("inserthtml",e)}},c.richEditor=!0,void f.click(function(){_upanel.open(c)}))})}(jQuery),function(a){upyun.setUpKEditor=function(b,c){var d='<span class="ke-outline" data-name="upyun" title="又拍" ><span class="ke-toolbar-icon ke-toolbar-icon-url" ></span></span>';c=upyun.util.checkOpts(c);var e=a(d).appendTo(a(".ke-toolbar",b.container));a(".ke-toolbar-icon",e).css({"background-image":"url("+c.editorIcon+")","background-size":"cover",height:"16px",width:"16px"}),c.onOK=function(a){for(var c=0,d=a.length;d>c;c++){var e=upyun.util.renderImg(a[c]);b.insertHtml(e)}},c.richEditor=!0,e.click(function(){_upanel.open(c)})}}(jQuery);