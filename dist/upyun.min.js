/*! Web-Developer-Suite-for-UPYUN 2014-05-11 */
!function(){var a=window.upyun||{};a.util={getDirName:function(a){var b=a.match(/([^/])*\/$/)[0];return b.length<1?"/":b},getScale:function(a,b,c,d){var e=a/b;return a>b?(nw=c,nh=nw/e,nh>d&&(nh=d,nw=nh*e)):(nh=d,nw=nh*e,nw>c&&(nh=nw/e)),{width:nw,height:nh}},formatDate:function(a){var b=new Date(1e3*a),c=b.getMonth()+1,d=b.getFullYear(),e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c=10>c?"0"+c.toString():c,f=10>f?"0"+f.toString():f,g=10>g?"0"+g.toString():g,h=10>h?"0"+h.toString():h,d+"-"+c+"-"+e+" "+f+":"+g+":"+h},checkOpts:function(a){var b={title:"请选择图片",panelLogo:"../themes/default/images/logo.png",editorIcon:"../themes/default/images/cloud.png",folderIcon:"../themes/default/images/Folder.png",tWidth:120,tHeight:74,multiSelect:!1,multiUpload:!1};return $.extend(b,a,{})},urlConcat:function(a,b){return a=a.split("#")[0],[a,b].join(-1===a.indexOf("?")?"?":"&")},renderImg:function(a){var b='<a target="#target#" href="#href#"><img #width# #height# alt="#alt#" src="#src#"></a>';return a.href=a.href||"",a.alt=a.alt||"",a.width=a.width?'width="'+a.width+'"':"",a.height=a.height?'height="'+a.height+'"':"",a.blank=a.blank||"",b.replace("#href#",a.href).replace("#src#",a.url).replace("#alt#",a.alt).replace("#target#",a.blank).replace("#width#",a.width).replace("#height#",a.height)}},function(b){"use strict";a.uploader=function(a,c){this.trigger=b(a),this.opts={post:{},multiUpload:!1},this.opts=b.extend(this.opts,c,{}),this.init()},a.uploader.prototype={init:function(){var a=this;this.uploadInput=b('<input type="file" class="hide mc-upload-holder">'),this.trigger.click(function(){a.uploadInput.click()}),a.uploadInput.on("change",function(){function c(){}for(var d=0,e=this.files.length;e>d;d++){var f=new FormData;void 0!==a.opts.post&&b.each(a.opts.post,function(a,b){f.append(a,b)}),f.append("file",this.files[d]),b.ajax({url:a.opts.api,type:"POST",xhr:function(){var a=b.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",c,!1),a},success:function(c){console.log(b.ajaxSettings.xhr().upload),c=b.parseJSON(c),a.opts.onSuccess&&a.opts.onSuccess(c)},data:f,cache:!1,contentType:!1,processData:!1})}})},setOpts:function(a){this.opts=b.extend(this.opts,a,{}),this.opts.multiUpload&&this.uploadInput.attr("multiple","multiple")}}}(jQuery),function(b){"use strict";a.panel=function(){this._stack=[],this._curPath="/",this._setup(),this.eventHandle()},a.panel.prototype={loadData:function(a){if(!this.loading){var c=this;c.loading=!0,b.post(this._getUrl("list"),{path:c._curPath},function(d){c.loading=!1,d=b.parseJSON(d),a(d.error),0===d.error&&c.objsHolder.html("");for(var e=0;e<d.data.length;e++){var f=d.data[e];c._appendFile(f)}c._cnt.text(d.data.length)})}},eventHandle:function(){var c=this;this.btnClose.click(function(a){a.preventDefault(),c.close()}),this.btnCancel.click(function(a){a.preventDefault(),c.close()}),this.btnOk.click(function(){var a=c;event.preventDefault();var b={url:a._g("image").attr("src"),width:a._g("width").val(),height:a._g("height").val(),alt:a._g("alt").val(),href:a._g("href").val(),blank:a._g("blank").val()};a.fireEvent("onOK",[b]),a.close()}),this.objsHolder.delegate("li","click",function(){c.now.multiSelect||b(".fs-selected",c.objsHolder).removeClass("fs-selected"),b(this).toggleClass("fs-selected"),b(".fs-selected",c.objsHolder).length<1?c.objsHolder.css({width:"auto"}):(c.objsHolder.css({width:"800px"}),c.fireEvent("onSelected",this));var d=b(this)._d("type"),e={type:d,name:b(this)._d("name"),url:c.now.folderIcon,time:a.util.formatDate(parseInt(b(this)._d("time"),10))};"file"==d&&(e.url=b(this)._d("url"),e.size=(parseInt(b(this)._d("size"),10)/1024).toFixed(2)),c._editFile(e)}),this.uploader=new a.uploader(this.upload,{onSuccess:function(a){return 0!==a.error?alert(a.msg):c._appendFile(a.data,!0)}}),this.objsHolder.delegate("li","mouseenter",function(){b(this).addClass("fs-hover")}),this.objsHolder.delegate("li","mouseleave",function(){b(this).removeClass("fs-hover")}),this.breadCrumbs.delegate("a","click",function(a){a.preventDefault(),c._openFolder(b(this).attr("href"))}),this.mkdir.click(function(a){a.preventDefault(),c._dialog("prompt","请输入文件夹名称",function(a,d){b.post(c._getUrl("mkdir"),{path:c._curPath,name:d},function(a){a=b.parseJSON(a),0===a.error?(c._dialog("success",a.msg),c._appendFile(a.data,!0)):c._dialog("error",a.msg)})})}),this.objsHolder.delegate(".fs-del","click",function(a){a.preventDefault();var d=b(this);return c._dialog("confirm","确定要删除该文件吗？",function(a){a&&c._deleteFile(d.next()._d("name"),function(a){a&&d.parent().remove()})})}),this.objsHolder.delegate("li","dblclick",function(){if(b(this).hasClass("fs-folder"))c._openFolder(c._curPath+"/"+b(this)._d("name")+"/");else{var a=b(this)._d("url");c.fireEvent("onOK",[{url:a}]),c.close()}})},fireEvent:function(a,b){return this.now&&this.now.hasOwnProperty(a)?this.now[a](b):void 0},close:function(){b("li",this.objsHolder).removeClass("fs-selected"),this.cover.hide()},open:function(b){var c=a.util.checkOpts(b);this._applyOpts(c),this.now=c,this._openFolder("/"),this.cover.show()},_openFolder:function(c){c=c.replace("//","/");var d=this._stack.indexOf(c),e=this;if(0>d){var f=(this._stack.indexOf(this._curPath),c.split("/").length-1);this._stack.splice(f-1),b("a",this.breadCrumbs).each(function(a,b){a>=f-1&&b.remove()}),e._curPath=c,this.loadData(function(b){if(0===b){var d=a.util.getDirName(c);e._stack.push(c),e.breadCrumbs.append('<a href="'+c+'">'+d+"</a>"),e._setBreadSelected(c),e._editFile({name:"/"==d?"根目录":d,url:e.now.folderIcon})}})}else e._curPath=c,this.loadData(function(a){0===a&&e._setBreadSelected(c)});this.uploader.setOpts({api:this._getUrl("upload"),multiUpload:!0,post:{path:this._curPath}})},_setBreadSelected:function(a){b("a",this.breadCrumbs).each(function(){b(this).attr("href")==a?b(this).addClass("cur-bread"):b(this).removeClass("cur-bread")})},_dialog:function(a,c,d){var e=this,f=b(".fs-msg",this.dialog),g=b("a",this.dialog);f.attr("class","fs-msg"),f.addClass("fs-"+a),f.html("<i></i>"),g.show(),"prompt"==a?(f.html("<span>"+c+'</span><input class="v" type="text" />'),b(".fs-cancel",this.dialog).hide()):("confirm"!=a&&b(".fs-cancel",this.dialog).hide(),f.html("<span>"+c+"</span>")),this.dialog.animate({height:"150"}),this.dialog.undelegate("a","click"),this.dialog.delegate("a","click",function(a){a.preventDefault();var c=b(".v",f),g=!1;c.length>0&&(g=c.val()),d&&d(b(this).hasClass("fs-confirm"),g),e.dialog.animate({height:0})})},_editFile:function(a){var c=b('<img class="fs-image" />').attr("src",a.url),d=b('<ul class="fs-info" />');if(d.append("<li>名称："+a.name+"</li>"),a.size>0&&d.append("<li>大小："+a.size+"K</li>"),a.time&&d.append("<li>创建时间："+a.time+"</li>"),this.edit.html(""),this.edit.append(d),this.now.richEditor&&"file"==a.type){var e=b('<ul class="fs-meta" />');e.append('<li><label>宽度：<input class="fs-width" type="text" /></label></li>'),e.append('<li><label>高度：<input class="fs-height" type="text" /></label></li>'),e.append('<li><label>链接：<input class="fs-href" value="'+a.url+'" type="text" /></label></li>'),e.append('<li><label>代替文本：<input class="fs-alt" value="'+a.name+'" type="text" /></label></li>'),e.append('<li><label>新标签中打开：<input class="fs-blank" value="" type="checkbox" /></label></li>'),this.edit.append(e),c.load(function(){b(".fs-width").val(this.width),b(".fs-height").val(this.height)})}this.edit.prepend(c)},_appendFile:function(c,d){var e=this,f=b("<img />"),g=b("<li />"),h=["name","size","type","time","url","width","height"];g.append('<a class="fs-del" href="#" >×</a>'),g.css({width:e.now.tWidth});for(var i=0;i<h.length;i++){var j=h[i];void 0!==c[j]&&g.attr("data-"+j,c[j])}if("folder"==c.type?(f.attr("src",e.now.folderIcon),g.addClass("fs-folder")):f.attr("src",c.url+e.now.style),f.attr("alt",c.name),f.attr("title",c.name),f._d("name",c.name),c.width&&c.height){var k=a.util.getScale(c.width,c.height,e.now.tWidth,e.now.tHeight);f.css(k)}else f.load(function(){var c=a.util.getScale(this.naturalWidth,this.naturalHeight,e.now.tWidth,e.now.tHeight);b(this).animate(c)});g.append(f),d?"file"==c.type?b(".fs-folder:last",e.objsHolder).after(g):g.prependTo(e.objsHolder):g.appendTo(e.objsHolder)},_deleteFile:function(a,c){var d=this;b.post(this._getUrl("delete"),{path:this._curPath,name:a},function(a){a=b.parseJSON(a),0===a.error?(c(!0),d._dialog("success","删除成功")):(c(!1),d._dialog("error",a.msg))})},_applyOpts:function(a){b("img",this.logo).attr("src",a.panelLogo),this.headConetnt.find("p").text(a.title)},_getUrl:function(b){return a.util.urlConcat(this.now.api,"action="+b)},_g:function(a){return b(".fs-"+a,this.cover)},_setup:function(){var a=this;if(!(a._g("cover").length>0)){var c='<div style="display:none;" class="fs-cover"><div class="fs-panel" style="height:500px;width:1120px;"><div class="fs-panel-left"><div id="fs-logo"><img src="../themes/default/images/logo.png" width="50"></div><div class="fs-tool-bar"><a class="fs-mkdir"><i></i>创建文件夹</a><a class="fs-upload"><i></i>上传图片</a></div></div><div class="fs-panel-right"><div class="fs-header"><div class="fs-header-left" style="width: 950px;"><h2>又拍图片中心</h2><p>请选择一张图片作为你的logo</p></div><a class="fs-close" style="margin-left:960px;">关闭</a></div><div class="fs-dialog"><div class="fs-dialog-wrapper"><div class="fs-msg"><i></i><span>确定要删除吗？</span></div><div class="fs-dialog-footer"><a href="#" class="fs-cancel">取消</a><a href="#" class="fs-confirm">确定</a></div></div></div><div class="fs-menu"><div class="fs-breadcrumbs"></div><div class="fs-search"></div></div><div class="fs-content" style="height:340px;"><div class="fs-content-left" style="width:800px"></div><div class="fs-content-right" style="margin-left:800px"></div></div><div class="fs-footer"><span>对象总数：<span class="fs-cnt" >125</span></span><a href="#" class="fs-confirm">确定</a><a href="#" class="fs-cancel">取消</a></div></div></div></div>';a.cover=b(c).appendTo(b("body")),a.panel=a._g("panel"),a.layoutLeft=a._g("panel-right"),a.toolbar=a._g("tool-bar"),a.upload=a._g("upload"),a.layoutRight=a._g("panel-right"),a.header=a._g("header"),a.headConetnt=a._g("header-left"),a.btnClose=a._g("close"),a.menu=a._g("menu"),a.breadCrumbs=a._g("breadcrumbs"),a.search=a._g("search"),a.content=a._g("content"),a.objsHolder=a._g("content-left"),a.edit=a._g("content-right"),a.footer=a._g("footer"),a.tip=b("span",this.footer),a.btnOk=a._g("confirm"),a.btnCancel=a._g("cancel"),a.dialog=a._g("dialog"),a._cnt=a._g("cnt"),a.mkdir=a._g("mkdir"),a.logo=a._g("logo"),b.fn.extend({_d:function(a){return b(this).attr("data-"+a)}})}}}}(jQuery),function(b){b.fn.upyun=function(c){return void 0===window._upanel&&(window._upanel=new a.panel({api:c.api})),this.each(function(){var a={style:"!small",multi:!1},d=b(this);a=b.extend(a,c,{}),a.title=d.attr("data-title"),a.onOK=a.onOK||function(a){for(var b=0,c=a.length;c>b;b++){var e=a[b];d.val(e.url)}},d.click(function(){window._upanel.open(a)})})}}(jQuery),function(b){"use strict";void 0===a.setUpUEditor&&(a.setUpUEditor=function(c,d){var e='<div  class="edui-box edui-button edui-for-upyun edui-default"><div class="edui-default"><div class="edui-button-wrap edui-default"><div unselectable="on" title="又拍" class="edui-button-body edui-default"><div class="edui-box edui-icon edui-default"></div><div class="edui-box edui-label edui-default"></div></div></div></div></div>',f=b(".edui-toolbar"),g=b(e);return d=a.util.checkOpts(d),f.length<1?(console.log("集成 UEDITOR 失败"),!1):(g.appendTo(f),b(".edui-icon",g).css({"background-image":"url("+d.editorIcon+")","background-size":"cover"}),d.onOK=function(b){for(var d=0,e=b.length;e>d;d++){var f=a.util.renderImg(b[d]);c.execCommand("inserthtml",f)}},d.richEditor=!0,void g.click(function(){_upanel.open(d)}))})}(jQuery),function(b){a.setUpKEditor=function(c,d){var e='<span class="ke-outline" data-name="upyun" title="又拍" ><span class="ke-toolbar-icon ke-toolbar-icon-url" ></span></span>';d=a.util.checkOpts(d);var f=b(e).appendTo(b(".ke-toolbar",c.container));b(".ke-toolbar-icon",f).css({"background-image":"url("+d.editorIcon+")","background-size":"cover",height:"16px",width:"16px"}),d.onOK=function(b){for(var d=0,e=b.length;e>d;d++){var f=a.util.renderImg(b[d]);c.insertHtml(f)}},d.richEditor=!0,f.click(function(){_upanel.open(d)})}}(jQuery)}(jQuery);